# 부록 A 처음 해보는 성능 테스트를 위한 기본 정리

- [성능 테스트 종류](#성능-테스트-종류)
- [포화점과 버클존](#포화점과-버클존)
- [주요 측정 지표](#주요-측정-지표)
- [성능 테스트 설계 시 고려 사항](#성능-테스트-설계-시-고려-사항)
- [성능 테스트 도구](#성능-테스트-도구)
- [성능 테스트 실행 시 주의 사항](#성능-테스트-실행-시-주의-사항)
- [마무리](#마무리)

## 성능 테스트 종류

만든 서버가 어느 정도의 트래픽을 감당할 수 있는지 확인하려면 실제로 측정이 필요한데, 이를 성능 테스트라고 부른다.
성능 테스트는 일반적으로 특정 작업 부하 상태에서 응답성과 안정성 측면에서 시스템이 어떻게 작동하는지를 확인하기 위해 수행하는 테스트 관행이다.

주로 사용하는 성능 테스트 종류는 다음과 같다.

- 부하(load) 테스트: 특정한 예상 부하에서 시스템이 어떻게 작동하는지 확인한다. 주요 기능의 응답 시간과 철리량 등의 성능 지표를 측정한다.
- 스트레스(stress) 테스트: 시스템의 최대 성능을 확인하기 위한 테스트로, 예상을 뛰어넘는 부하가 발생했을 때, 시스템이 어떻게 반응하는지를 평가한다.
- 지속 부하(soak) 테스트: 장기간에 걸쳐 일정한 부하를 가했을 때, 시스템이 안정적으로 작동하는지를 확인한다. 메모리 누수나 자원 고갈 문제 등을 발견하는 데 유용하다.
- 스파이크(spike) 테스트: 갑작스러운 급격한 부하 증가에 대해 시스템이 어떻게 반응하는지를 확인한다.

## 포화점과 버클존

일반적으로 성능 테스트를 진행할 때는 낮은 부하에서부터 시작해서 점차 부하를 증가시키면서 시스템의 성능을 측정한다.
예를 들어, 동시 사용자 수를 100명에서 시작해서 200명, 300명으로 늘려가면서 응답 시간과 처리량을 측정하는 식이다.

점진적으로 부하를 증가시키면 초기에는 처리량도 함께 증가하는데, 어느 시점부터는 증가 폭이 줄어들고, 처리량과 응답 시간이 급격히 나빠지는 구간이 나타난다.
이때 성능이 저하되기 전의 최대 처리량을 포화점(saturation point)이라고 부른다.
즉, 포화점은 시스템이 감당할 수 있는 성능 한계 지점이라고 할 수 있다.

포화점을 지나 성능이 꺾이기 시작하는 구간을 버클존(bottleneck zone)이라고 부른다.

포화점이 목표로 한 성능보다 높다면 성능 테스트를 끝낼 수 있다.
하지만 그렇지 않다면 병목 지점을 찾아 해결한 후, 다시 성능 테스트를 진행해야 한다.

## 주요 측정 지표

### 응답 시간

- 평균
- 최대
- 최소
- 중앙
- 99%, 95% 백분위

응답 시간의 평균과 최대 값의 차이가 크다면 99%나 95% 백분위 값을 함께 살펴보자.
이 백분위 값이 최대 응답 시간보다 평균 값에 가깝다면 최대 값은 이상치일 수 있다.

응답 시간이 중앙 값보다 평균 값이 더 큰 좌편향 분포를 보인다면 응답 시간이 전반적으로 평균보다 느리다는 의미다.

### 처리량

처리량은 TPS(Transactions Per Second)나 RPS(Requests Per Second)로 표현하며,
초 단위로 얼마나 많은 요청을 처리하는지를 의미한다.

테스트를 진행하는 동안 처리량은 계속 바뀌기 때문에 최대, 최소, 평균 값을 함께 살펴보자.

### 에러율

에러율은 전체 요청 중에서 실패한 요청이 차지하는 비율을 의미한다.
에러율이 높다면 시스템에 문제가 있을 가능성이 크므로, 에러 로그를 확인하자.

### CPU 사용률

일반적으로 웹 서버의 성능 문제는 DB나 외부 연동에서 발생하지만, 높은 CPU 사용률도 성능 저하의 원인이 될 수 있다.
CPU 사용률을 측정하면 문제 원인을 파악하는 데 도움이 된다.

## 성능 테스트 설계 시 고려 사항

- 시스템의 트래픽 패턴
    - 실제 서비스의 트래픽 패턴을 반영해야 한다.
- 동시 요청 사용자 수 / 트래픽 규모
    - 트래픽 규모가 큰 서비스는 여러 대의 부하 발생기를 사용해야 할 수도 있다.
- 기능별 요청 비율
    - 실제 사용자 행동 패턴을 반영해야 한다.
- 데이터 크기
    - 예상 규모에 맞는 데이터를 준비해야 신뢰성 있는 결과를 얻을 수 있다.
- 워밍업
    - 테스트 시작 전에 시스템을 예열하여 안정적인 상태에서 측정을 시작해야 한다.
- 적절한 목표치 설정
    - 10만 TPS로 목표를 세우는 것보다, 현실적인 목표치를 설정하는 것이 중요하다.

## 성능 테스트 도구

상황에 맞게 다양한 성능 테스트 도구를 활용할 수 있다.

- Ngrinder
- K6
- Locust
- Gatling
- JMeter

## 성능 테스트 실행 시 주의 사항

- 테스트 대상 시스템과 부하기를 한 장비에서 실행하지 말자.
    - 부하를 발생시키는 과정에서 많은 리소스를 사용하기 때문에, 테스트 대상 시스템의 성능에 영향을 줄 수 있다.
- 부하 테스트기의 원활한 동작을 위해 IP당 요청 제한과 같은 네트워크 제약 조건을 확인하자.
- 운영 시스템과 동일한 네트워크 환경에서 부하 테스트를 조심하자.
    - 네트워크 대역폭이 제한적이라면, 부하 테스트가 운영 시스템에 영향을 줄 수 있다.
- 외부 서비스를 연동하는 기능을 테스트한다면, 가짜 외부 서비스로 대체하자.
- 테스트 대상 시스템은 최대한 운영 환경과 유사하게 구성하자. (컴퓨팅 자원, 네트워크 설정, 데이터베이스 상태 등)

성능 테스트는 지루한 과정의 연속이다.
목표로 한 성능이 안 나오면 병목을 찾기 위해 분석해야 한다.
의심되는 부분을 수정했다면, 다시 성능 테스트를 돌려야 한다.
이 과정을 반복하다 보면 어느새 목표로 한 성능에 도달해 있을 것이다.

## 마무리

성능 테스트를 더 잘하려면 서비스의 대한 깊은 이해가 필요하다.
서비스 특성에 맞는 부하 배턴, 더미 데이터, 사용 패턴 등을 고민해야만 신뢰성 있는 결과를 얻을 수 있다.
스스로도 이 테스트가 실제 상황을 잘 반영하고 있는지 계속 점검해야 할 것이다.
